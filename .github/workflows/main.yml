# name: CI/CD Docker DevSecOps

# on:
#   push:
#     branches: [ main, develop, feature ]
#   pull_request:
#     branches: [ main, develop, feature ]

# jobs:
#   security-build:
#     runs-on: ubuntu-latest

#     steps:
#       - name: üì• Checkout code
#         uses: actions/checkout@v4

#       # === PHASE DE S√âCURIT√â ===
#       - name: üîç Analyse de code (Bandit)
#         run: |
#           pip install bandit jq
#           bandit -r . -f json -o bandit-full.json || true
#           jq '[.results[] | select(.issue_severity == "MEDIUM" or .issue_severity == "HIGH")]' bandit-full.json > bandit-report.json

#       - name: üì¶ Scan des d√©pendances (OWASP)
#         run: |
#           curl -L -o dependency-check.zip https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.7/dependency-check-9.0.7-release.zip
#           unzip dependency-check.zip -d dependency-check && rm dependency-check.zip
#           ./dependency-check/bin/dependency-check.sh -s . -o ./owasp-report -f JSON
#           jq '[.dependencies[] | select(.vulnerabilities != null) | .vulnerabilities[] | select(.severity == "MEDIUM" or .severity == "HIGH")]' ./owasp-report/dependency-check-report.json > owasp-filtered.json

#       - name: üê≥ Analyse de l'image Docker (Trivy)
#         run: |
#           sudo apt-get update && sudo apt-get install -y wget gnupg lsb-release
#           wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
#           echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
#           sudo apt-get update && sudo apt-get install -y trivy
#           trivy fs --security-checks vuln --severity MEDIUM,HIGH,CRITICAL --exit-code 0 --format json -o trivy-results.json .

#       # === NOTIFICATION EMAIL ===
#       - name: üìß Envoyer un email au responsable
#         uses: dawidd6/action-send-mail@v3
#         with:
#           server_address: smtp.example.com
#           server_port: 587
#           username: ${{ secrets.SMTP_USERNAME }}
#           password: ${{ secrets.SMTP_PASSWORD }}
#           subject: "üì¢ R√©sultats des scans de s√©curit√© CI/CD"
#           to: ${{ github.repository_owner }}
#           from: "ci-pipeline@monprojet.dev"
#           body: |
#             Bonjour,

#             Le pipeline CI/CD a termin√© l‚Äôanalyse de s√©curit√©. Voici les vuln√©rabilit√©s filtr√©es :

#             Bandit : bandit-report.json  
#             D√©pendances : owasp-filtered.json  
#             Trivy : trivy-results.json

#             Cordialement,  
#             Votre pipeline automatis√©.

#           attachments: |
#             bandit-report.json
#             owasp-filtered.json
#             trivy-results.json

#       # === ARCHIVAGE ===
#       - name: üìÑ Archivage des rapports
#         uses: actions/upload-artifact@v4
#         with:
#           name: rapports-securite
#           path: |
#             bandit-report.json
#             owasp-filtered.json
#             trivy-results.json

#       # === NETTOYAGE ===
#       - name: üßπ Nettoyage
#         run: |
#           docker system prune -f
#           docker save my-app -o my-app.tar && gzip my-app.tar

#       - name: ‚¨ÜÔ∏è Upload image Docker
#         if: github.ref == 'refs/heads/main'
#         uses: actions/upload-artifact@v4
#         with:
#           name: docker-image
#           path: my-app.tar.gz


# #=================================================
# #=============== DEBUT ====================
# #=================================================


# # name: CI/CD Docker DevSecOps with SendGrid

# # on:
# #   push:
# #     branches: [main, develop, feature]
# #   pull_request:
# #     branches: [main, develop, feature]

# # jobs:
# #   security-build:
# #     runs-on: ubuntu-latest

# #     steps:
# #       - name: üì• Checkout code
# #         uses: actions/checkout@v4

# #       # === SECURITY SCANNING ===
# #       - name: üîç Static Code Analysis (Bandit)
# #         run: |
# #           python -m pip install bandit
# #           bandit -r . -f json -o bandit-report.json || echo "Bandit scan completed"

# #       - name: üì¶ Dependency Scanning (OWASP)
# #         uses: dependency-check/Dependency-Check_Action@main
# #         with:
# #           project: 'Security Report'
# #           scanpath: '.'
# #           format: 'HTML'
# #           out: './security-report'

# #       - name: üê≥ Container Scanning (Trivy)
# #         run: |
# #           sudo apt-get install -y wget apt-transport-https gnupg lsb-release
# #           wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
# #           echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
# #           sudo apt-get update
# #           sudo apt-get install -y trivy
# #           trivy fs --security-checks vuln --severity HIGH,CRITICAL --exit-code 0 --format table -o trivy-results.txt .

# #       # === BUILD ===
# #       - name: üõ†Ô∏è Build Docker Image
# #         run: |
# #           docker build -t my-app --pull --no-cache .
# #           docker scan --file Dockerfile my-app > docker-scan-report.txt || echo "Docker scan completed"

# #       # === TESTING ===
# #       - name: üß™ Security Testing (ZAP)
# #         uses: zaproxy/action-baseline@v0.10.0
# #         continue-on-error: true
# #         with:
# #           target: 'http://localhost:8080'
# #           rules: 'rules/security'
# #           report_html: 'zap-report.html'

# #       # === REPORT COLLECTION ===
# #       - name: üì¶ Package Security Reports
# #         run: |
# #           mkdir -p combined-reports
# #           cp bandit-report.json combined-reports/
# #           cp security-report/dependency-check-report.html combined-reports/
# #           cp trivy-results.txt combined-reports/
# #           cp docker-scan-report.txt combined-reports/
# #           cp zap-report.html combined-reports/
          
# #           # Create summary file
# #           echo "Security Scan Summary" > combined-reports/summary.txt
# #           echo "====================" >> combined-reports/summary.txt
# #           echo "Bandit Findings: $(grep -c '"issue"' bandit-report.json || echo 0)" >> combined-reports/summary.txt
# #           echo "Dependency Vulnerabilities: $(grep -c 'vulnerability' security-report/dependency-check-report.html || echo 0)" >> combined-reports/summary.txt
# #           echo "Container Vulnerabilities: $(grep -c 'HIGH\|CRITICAL' trivy-results.txt || echo 0)" >> combined-reports/summary.txt

# #       - name: üì§ Upload Reports Artifact
# #         uses: actions/upload-artifact@v4
# #         with:
# #           name: security-reports
# #           path: combined-reports/

# #       # === SENDGRID EMAIL ===
# #       - name: üìß Send Security Report via SendGrid
# #         if: always()
# #         uses: actions-hub/sendgrid@master
# #         env:
# #           SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
# #           EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
# #           EMAIL_TO: ${{ secrets.EMAIL_TO }}
# #           EMAIL_SUBJECT: "Security Scan Report - ${{ github.repository }} - ${{ github.sha }}"
# #           EMAIL_BODY: "Please find attached the security scan reports."
# #         with:
# #           files: |
# #             combined-reports/bandit-report.json
# #             combined-reports/dependency-check-report.html
# #             combined-reports/trivy-results.txt
# #             combined-reports/docker-scan-report.txt
# #             combined-reports/zap-report.html
# #             combined-reports/summary.txt

# #       # === CLEANUP ===
# #       - name: üßπ Cleanup
# #         run: |
# #           docker system prune -f
# #       - name: üßπ Nettoyage des fichiers temporaires
# #         run: |
# #           # Suppression conditionnelle
# #           [ -f trivy_envs.txt ] && rm -f trivy_envs.txt || echo "Fichier trivy_envs.txt non trouv√©"
# #           docker system prune -f
# #           docker save my-app -o my-app.tar
# #           gzip my-app.tar
# #         continue-on-error: true

# #       - name: ‚¨ÜÔ∏è Upload image package
# #         if: github.ref == 'refs/heads/main'
# #         uses: actions/upload-artifact@v4
# #         with:
# #           name: docker-image
   

# #=================================================
# #================ FIN ====================
# #=================================================


# name: CI/CD Docker DevSecOps

# on:
#   push:
#     branches: [main, develop, feature]
#   pull_request:
#     branches: [main, develop, feature]

# jobs:
#   security-build:
#     runs-on: ubuntu-latest

#     steps:
#       - name: üì• Checkout code
#         uses: actions/checkout@v4

#       # === SCAN BANDIT ===
#       - name: üîç Analyse Bandit (S√©v√©rit√© filtr√©e)
#         run: |
#           pip install bandit jq
#           bandit -r . -f json -o bandit-full.json || true
#           jq '[.results[] | select(.issue_severity=="MEDIUM" or .issue_severity=="HIGH")]' bandit-full.json > bandit-report.json

#       # === SCAN D√âPENDANCES (OWASP) ===
#       - name: üì¶ D√©tection de vuln√©rabilit√©s d√©pendances
#         run: |
#           curl -L -o dep-check.zip https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.7/dependency-check-9.0.7-release.zip
#           unzip dep-check.zip -d dep-check && rm dep-check.zip
#           ./dep-check/bin/dependency-check.sh -s . -o ./owasp-report -f JSON || true
#           jq '[.dependencies[] | select(.vulnerabilities) | .vulnerabilities[] | select(.severity=="MEDIUM" or .severity=="HIGH")]' ./owasp-report/dependency-check-report.json > owasp-filtered.json

#       # === SCAN TRIVY ===
#       - name: üê≥ Analyse Docker avec Trivy
#         run: |
#           sudo apt-get update && sudo apt-get install -y wget gnupg lsb-release
#           wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
#           echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
#           sudo apt-get update && sudo apt-get install -y trivy
#           trivy fs --security-checks vuln --severity MEDIUM,HIGH,CRITICAL --format json -o trivy-results.json . || true

#       # === NOTIFICATION EMAIL ===
#       - name: üìß Envoi mail de s√©curit√©
#         uses: dawidd6/action-send-mail@v3
#         with:
#           server_address: smtp.example.com
#           server_port: 587
#           username: ${{ secrets.SMTP_USERNAME }}
#           password: ${{ secrets.SMTP_PASSWORD }}
#           subject: "[CI/CD] R√©sultats DevSecOps - ${{ github.repository }}"
#           to: ${{ github.repository_owner }}
#           from: "ci@security-bot.dev"
#           body: |
#             Bonjour ${{ github.repository_owner }},

#             Votre d√©p√¥t a √©t√© analys√© automatiquement par le pipeline DevSecOps :

#             - Vuln√©rabilit√©s Bandit (moyennes/hautes)
#             - D√©pendances sensibles d√©tect√©es
#             - R√©sultats de scan Trivy

#             Consultez les rapports ci-joints pour en savoir plus.

#             -- L'√©quipe CI/CD
#           attachments: |
#             bandit-report.json
#             owasp-filtered.json
#             trivy-results.json

#       # === NOTIFICATION SLACK ===
#       - name: üì¢ Alerte Slack
#         uses: slackapi/slack-github-action@v1.24.0
#         with:
#           payload: |
#             {
#               "text": ":rotating_light: *R√©sultats DevSecOps CI/CD - ${{ github.repository }}*",
#               "attachments": [
#                 {
#                   "color": "#e01e5a",
#                   "fields": [
#                     {
#                       "title": "Bandit",
#                       "value": "‚úîÔ∏è Vuln√©rabilit√©s filtr√©es (MEDIUM/HIGH)"
#                     },
#                     {
#                       "title": "D√©pendances",
#                       "value": "‚úîÔ∏è Rapports OWASP g√©n√©r√©s"
#                     },
#                     {
#                       "title": "Docker Scan",
#                       "value": "‚úîÔ∏è R√©sultats Trivy disponibles"
#                     }
#                   ]
#                 }
#               ]
#             }
#         env:
#           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

#       # === BUILD IMAGE DOCKER ===
#       - name: üõ†Ô∏è Build image Docker
#         run: |
#           docker build -t my-app --pull --no-cache . || exit 1

#       # === ARCHIVAGE ===
#       - name: üìÑ Archivage des rapports
#         uses: actions/upload-artifact@v4
#         with:
#           name: rapports-securite
#           path: |
#             bandit-report.json
#             owasp-filtered.json
#             trivy-results.json

#       # === NETTOYAGE ===
#       - name: üßº Nettoyage et export image
#         run: |
#           docker save my-app -o my-app.tar && gzip my-app.tar
#           docker system prune -f
#         continue-on-error: true

#       # === UPLOAD IMAGE FINAL ===
#       - name: ‚¨ÜÔ∏è Upload de l'image Docker
#         if: github.ref == 'refs/heads/main'
#         uses: actions/upload-artifact@v4
#         with:
#           name: docker-image
#           path: my-app.tar.gz




#################################################################33
name: CI/CD Docker DevSecOps

on:
  push:
    branches: [main, develop, feature/**]
  pull_request:
    branches: [main, develop]

jobs:
  security-build:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # N√©cessaire pour SonarQube

      # === üîç Analyse statique avec SonarQube ===
      - name: Analyse SonarQube
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=my-project
            -Dsonar.projectName=My_Project
            -Dsonar.exclusions=**/tests/**,**/node_modules/**

      # === üîç Analyse de s√©curit√© avec BANDIT ===
      - name: Analyse Bandit
        run: |
          pip install bandit jq
          bandit -r . -f json -o bandit-full.json || true
          jq '[.results[] | select(.issue_severity=="MEDIUM" or .issue_severity=="HIGH")]' bandit-full.json > bandit-report.json

      # === üì¶ Analyse de d√©pendances (OWASP) ===
      - name: Scan des d√©pendances
        run: |
          curl -L -o dep-check.zip https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.7/dependency-check-9.0.7-release.zip
          unzip dep-check.zip -d dep-check && rm dep-check.zip
          ./dep-check/bin/dependency-check.sh -s . -o owasp-report -f JSON || true
          jq '[.dependencies[] | select(.vulnerabilities) | .vulnerabilities[] | select(.severity=="MEDIUM" or .severity=="HIGH")]' owasp-report/dependency-check-report.json > owasp-filtered.json

      # === üê≥ Analyse de l'image Docker (TRIVY) ===
      - name: Docker scan avec Trivy
        run: |
          sudo apt-get update && sudo apt-get install -y wget gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update && sudo apt-get install -y trivy
          trivy fs --security-checks vuln --severity MEDIUM,HIGH,CRITICAL --format json -o trivy-results.json . || true

      # === üõ†Ô∏è Build de l'image Docker ===
      - name: Build image Docker
        run: |
          docker build -t my-app:${{ github.sha }} --pull --no-cache . || exit 1

      # === üîê Archivage de s√©curit√© ===
      - name: Archivage des rapports
        uses: actions/upload-artifact@v4
        with:
          name: rapports-securite-${{ github.run_id }}
          path: |
            bandit-report.json
            owasp-filtered.json
            trivy-results.json
          retention-days: 7

      # === ‚úâÔ∏è Envoi de l'alerte EMAIL ===
      - name: Notification Email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[CI/CD] R√©sultats DevSecOps - ${{ github.repository }}"
          to: ${{ secrets.EMAIL_RECIPIENT }}
          from: "CI/CD Pipeline <noreply@mycompany.com>"
          body: |
            Rapport de s√©curit√© CI/CD pour le commit ${{ github.sha }}:
            
            üîç SonarQube: ${{ secrets.SONAR_HOST_URL }}/dashboard?id=my-project
            ‚úÖ Bandit: bandit-report.json  
            ‚úÖ D√©pendances: owasp-filtered.json  
            ‚úÖ Docker Scan: trivy-results.json

            Job URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          attachments: |
            bandit-report.json
            owasp-filtered.json
            trivy-results.json

      # === üì® Notification Slack ===
      - name: Alerte Slack
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": ":lock: R√©sultats DevSecOps CI/CD *${{ github.repository }}* (commit: ${{ github.sha }}) :",
              "attachments": [
                {
                  "color": "#36a64f",
                  "fields": [
                    {"title": "SonarQube", "value": "<${{ secrets.SONAR_HOST_URL }}/dashboard?id=my-project|Rapport SonarQube>"},
                    {"title": "Bandit", "value": "`bandit-report.json`"},
                    {"title": "D√©pendances", "value": "`owasp-filtered.json`"},
                    {"title": "Trivy", "value": "`trivy-results.json`"}
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # === üßπ Nettoyage final ===
      - name: Nettoyage et export image
        run: |
          docker save my-app:${{ github.sha }} -o my-app.tar && gzip my-app.tar
          docker system prune -f
        continue-on-error: true

      # === üì¶ Upload de l'image Docker ===
      - name: Upload image Docker
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ github.run_id }}
          path: my-app.tar.gz
          retention-days: 7
##################################################################